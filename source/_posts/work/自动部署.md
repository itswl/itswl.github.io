---

title: 环境准备与自动卸载部署

date: 2019-5-13 10:51:16

tags:

categories: work

---
## 记录原因
**上个月为了减轻自己的工作量，将日常部署工作进行了流程化处理**
后来根据上级的要求，做了一个全自动化的安装卸载脚本，做完之后，给我提了如下修改意见。
因为本人又喜欢分享。**但因保密要求，提供的并非完整代码，只是一种示意。**
[github地址](https://github.com/itswl/work)

### 主要功能
1. 环境的一键搭建
2. xx的一键部署
3. xx的自动部署卸载
xx部署，部署成功一个小时后，自动卸载后重新部署。如果部署失败，则停止部署。
(还可以扩展，部署失败自动发邮件等)

### 遇到的主要问题

1. 密码问题(写入到配置文件当中，后续可以进行加密后写入配置文件)
2. 后台命令，不能read终端输出的问题（用python传入密码，读出解决）
3. 集群卸载问题（从配置文件中利用正则筛选出集群ip，scp传送文件，ssh执行命令，然后用pexcept解决password以及yes/no的输入。）
（利用paramiko更加容易，但尽量使用python原生方式）
4. 自动脚本的停止（对linux 的kill -9 进行了一下封装，统一调用）
5. 简化使用问题（使用try,except对调用进行提示，尽量减少别人查看使用方法）

### 检视意见
1. 重复卸载，需要提供提示
2. 工具运行脚本需简化，提供统一调用接口，接口用法需要提示用户
3. 工具使用文档内容离散难懂，需要整理说明
4. 工具代码中增加异常保护和处理
5. 判断安装是否成功不应该读取日志，而是通过调用脚本返回值判断
6. xx安装完成后，需要增加判断xx是否能使用
7. 提供安装策略文件，支持以不同方式安装xx，比如：双平面, 单机, 集群, 多操作系统等
8. 系统命令统一使用shell脚本，便于修改
9. 工具需要屏蔽xx版本差异
10. root节点的密码需要加密保存
11. 安装过程信息需要记录到日志中
12. python代码中增加异常保护
13. 整个工具按照通用的方式去排查，硬编码的内容建议抽取放置到配置文件中

检视的代码，是因为最初只是想完成功能，就面向过程写的，最后要兼容不同的部署方式，以及未来的扩展需求，于是改用面向对象
**虽然以面向对象的方式写脚本有点刻意，但以面向过程的方式，不易扩展，改写困难，加上训练一下自己，所以改写**。

### 环境准备
详情见：
[setting.py](https://github.com/itswl/work/blob/master/setting.py)
[upload.py](https://github.com/itswl/work/blob/master/upload.py)

### 安装部署
详情见：
[部署卸载](https://github.com/itswl/work/blob/master/new/deploy.py)
[自动部署卸载](https://github.com/itswl/work/blob/master/new/auto_deploy.py)
